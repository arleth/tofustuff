# VelPharma Infrastructure

## Overview
This project manages the VelPharma infrastructure using OpenTofu and Docker.

## Structure
```
.
├── postgres/           # PostgreSQL database
│   ├── Dockerfile
│   └── init/          # Database initialization scripts
│       ├── 01-create-user.sql
│       ├── 02-create-schema.sql
│       └── 03-create-extensions.sql
├── backups/           # Database backup directory
├── reset-db.sh        # Script to rebuild database with fresh schema
├── docker-compose.yml # Service orchestration (postgres + pgadmin)
├── main.tf            # OpenTofu main configuration
├── variables.tf       # Configuration variables
└── .env               # Environment configuration (generated by OpenTofu)
```

## Getting Started

### Prerequisites
- Docker Desktop for Mac
- OpenTofu CLI

### Initial Setup
1. Initialize OpenTofu:
   ```bash
   tofu init
   ```

2. Apply configuration (generates .env and this README):
   ```bash
   tofu apply
   ```

3. Start the services:
   ```bash
   docker-compose up -d
   ```

4. Check services are running:
   ```bash
   docker-compose ps
   docker-compose logs -f
   ```

### Development Workflow

**When you change init scripts and want a clean slate:**
```bash
./reset-db.sh
```

**For normal development (keeps existing data):**
```bash
docker-compose up -d
```

### Services

#### PostgreSQL Database
- **Host:** localhost
- **Port:** 5434 (external) / 5432 (internal Docker network)
- **Database:** velpdevdb
- **User:** postgres
- **Password:** changeme
- **Schema:** vpv4

Connection string for external applications:
```
postgresql://postgres:changeme@localhost:5434/velpdevdb
```

Connection string for Docker services:
```
postgresql://postgres:changeme@postgres:5432/velpdevdb
```

#### PgAdmin (Database Management UI)
- **URL:** http://localhost:5050
- **Email:** admin@velpharma.com
- **Password:** admin

**To connect PgAdmin to database:**
- Host: `postgres`, Port: `5432`, Database: `velpdevdb`, User: `postgres`, Password: `changeme`

### Database Schema (vpv4)

**Core:** ATC_CODES, ACTIVE_SUBSTANCES, PRODUCTS, MANUFACTURERS
**ADRs:** ADVERSE_DRUG_REACTIONS, SYNONYMS, FREQUENCIES, ORGANS, SPECIALTIES, PARA_CLINICS
**Deprescribing:** DEPRESCRIBING_GUIDELINES, DEPRESCRIBING_CONDITIONS
**Staging:** IMPORT_STAGING_PRODUCTS_SUBSTANCES

### Data Loading Strategy

**Automatic (Default)**: Database loads from `backups/production_backup.sql` on init
**Fallback**: Seed file `_05-seed-base.sql` if no backup exists
**Manual**: See `DATABASE_WORKFLOW.md` for complete data management guide

### Useful Commands
```bash
# Start/stop services
docker-compose up -d
docker-compose down
docker-compose down -v              # Remove volumes (deletes data!)

# Logs
docker-compose logs -f
docker-compose logs -f postgres

# Database access
docker-compose exec postgres psql -U postgres -d velpdevdb

# Backup/restore
docker-compose exec postgres pg_dump -U postgres velpdevdb > backups/backup.sql
docker-compose exec -T postgres psql -U postgres velpdevdb < backups/backup.sql

# Reset database (deletes all data!)
./reset-db.sh
```

### Troubleshooting
- **No data after reset?** Ensure `backups/production_backup.sql` exists
- **Init scripts not running?** Use `./reset-db.sh` to force re-initialization
- **Port conflict?** Check with `lsof -i :5434`
- **PgAdmin can't connect?** Use host `postgres` (not `localhost`) and port `5432` (not `5434`)

### Important Files
- `DATABASE_WORKFLOW.md` - Complete data management guide
- `./reset-db.sh` - Reset database (loads backup)
- `./create-backup.sh` - Create new backup
- `./monitor-db.sh` - Monitor performance

## Configuration
Edit `variables.tf` and run `tofu apply` to regenerate `.env` and this README.

## Future Plans
- [ ] Add backend service container
- [ ] Add frontend service container
- [ ] Automated database migrations
- [ ] Kubernetes deployment
- [ ] CI/CD pipeline
