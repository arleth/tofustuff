-- Create VelPharma database schema and all tables
-- This script includes the complete schema so the Docker image is ready for data

\c velpdevdb;

-- Create the vpv4 schema
CREATE SCHEMA IF NOT EXISTS vpv4;

-- Set search path
SET search_path TO vpv4, public;
ALTER DATABASE velpdevdb SET search_path TO vpv4, public;

-- Include the complete schema definition
-- Note: This is the same content as schema/current/schema.sql but without the \c command

-- Drop existing tables in correct order (respecting foreign key constraints)
DROP TABLE IF EXISTS vpv4.SUBSTANCE_SYNONYMS CASCADE;
DROP TABLE IF EXISTS vpv4.PRODUCTS_ACTIVE_SUBSTANCES CASCADE;
DROP TABLE IF EXISTS vpv4.DEPRESCRIBING_GUIDELINES CASCADE;
DROP TABLE IF EXISTS vpv4.ACTIVE_SUBSTANCES CASCADE;
DROP TABLE IF EXISTS vpv4.IMPORT_STAGING_PRODUCTS_SUBSTANCES CASCADE;
DROP TABLE IF EXISTS vpv4.ADVERSE_DRUG_REACTIONS_SPECIALTIES CASCADE;
DROP TABLE IF EXISTS vpv4.ADVERSE_DRUG_REACTIONS_PARA_CLINICS CASCADE;
DROP TABLE IF EXISTS vpv4.ADVERSE_DRUG_REACTIONS_ORGANS CASCADE;
DROP TABLE IF EXISTS vpv4.PRODUCTS_ADVERSE_DRUG_REACTIONS_FREQUENCIES CASCADE;
DROP TABLE IF EXISTS vpv4.MANUFACTURERS_PRODUCTS CASCADE;
DROP TABLE IF EXISTS vpv4.PRODUCTS CASCADE;
DROP TABLE IF EXISTS vpv4.MANUFACTURERS CASCADE;
DROP TABLE IF EXISTS vpv4.PARA_CLINICS CASCADE;
DROP TABLE IF EXISTS vpv4.SPECIALTIES CASCADE;
DROP TABLE IF EXISTS vpv4.SYNONYMS CASCADE;
DROP TABLE IF EXISTS vpv4.ADVERSE_DRUG_REACTIONS CASCADE;
DROP TABLE IF EXISTS vpv4.ORGANS CASCADE;
DROP TABLE IF EXISTS vpv4.FREQUENCIES CASCADE;
DROP TABLE IF EXISTS vpv4.DEPRESCRIBING_CONDITIONS CASCADE;
DROP TABLE IF EXISTS vpv4.ATC_CODES CASCADE;

-- ATC Codes table (Anatomical Therapeutic Chemical Classification)
CREATE TABLE IF NOT EXISTS vpv4.ATC_CODES (
    ATC_CODE_ID INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY (INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1),
    ATC_CODE VARCHAR(7) UNIQUE,
    DESCRIPTION TEXT NOT NULL,
    LINK TEXT,
    ATC_LEVEL INTEGER NOT NULL,
    PARENT_CODE INTEGER,
    CREATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT FK_PARENT_CODE FOREIGN KEY (PARENT_CODE)
        REFERENCES vpv4.ATC_CODES (ATC_CODE_ID)
        ON DELETE SET NULL,
    CONSTRAINT PK_ATC_CODES PRIMARY KEY (ATC_CODE_ID)
);

-- Active Substances table
CREATE TABLE IF NOT EXISTS vpv4.ACTIVE_SUBSTANCES (
    ACTIVE_SUBSTANCE_ID INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY (INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1),
    SUBSTANCE_NAME TEXT NOT NULL,
    ATC_CODE_ID INTEGER,
    CONSTRAINT PK_ACTIVE_SUBSTANCES PRIMARY KEY (ACTIVE_SUBSTANCE_ID),
    CONSTRAINT FK_ACTIVE_SUBSTANCES_ATC FOREIGN KEY (ATC_CODE_ID)
        REFERENCES vpv4.ATC_CODES (ATC_CODE_ID)
        ON DELETE SET NULL
);

-- Substance Synonyms table
CREATE TABLE IF NOT EXISTS vpv4.SUBSTANCE_SYNONYMS (
    SYNONYM_ID INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY (INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1),
    ACTIVE_SUBSTANCE_ID INTEGER NOT NULL,
    SYNONYM_NAME TEXT NOT NULL,
    CONSTRAINT PK_SUBSTANCE_SYNONYMS PRIMARY KEY (SYNONYM_ID),
    CONSTRAINT FK_SUBSTANCE_SYNONYMS FOREIGN KEY (ACTIVE_SUBSTANCE_ID)
        REFERENCES vpv4.ACTIVE_SUBSTANCES (ACTIVE_SUBSTANCE_ID)
        ON DELETE CASCADE
);

-- Manufacturers table
CREATE TABLE IF NOT EXISTS vpv4.MANUFACTURERS (
    MANUFACTURER_ID INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    NAME TEXT NOT NULL,
    CREATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT PK_MANUFACTURERS PRIMARY KEY (MANUFACTURER_ID)
);

-- Products table (main drug information)
CREATE TABLE IF NOT EXISTS vpv4.PRODUCTS (
    PRODUCT_ID INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY (INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1),
    DRUG_ID BIGINT NOT NULL,
    ATC_CODE_ID INTEGER NOT NULL,
    PRODUCT_NAME TEXT NOT NULL,
    FORM TEXT NOT NULL,
    STRENGTH TEXT,
    CREATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT PK_PRODUCTS PRIMARY KEY (PRODUCT_ID),
    CONSTRAINT FK_ATC_CODES FOREIGN KEY (ATC_CODE_ID)
        REFERENCES vpv4.ATC_CODES (ATC_CODE_ID)
        ON UPDATE NO ACTION
        ON DELETE NO ACTION
);

-- Products Active Substances junction table
CREATE TABLE IF NOT EXISTS vpv4.PRODUCTS_ACTIVE_SUBSTANCES (
    PRODUCT_ID INTEGER NOT NULL,
    ACTIVE_SUBSTANCE_ID INTEGER NOT NULL,
    IS_PRIMARY_SUBSTANCE BOOLEAN DEFAULT true,
    CREATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT PK_PRODUCTS_ACTIVE_SUBSTANCES PRIMARY KEY (PRODUCT_ID, ACTIVE_SUBSTANCE_ID),
    CONSTRAINT FK_PRODUCTS_SUBSTANCES_PRODUCT FOREIGN KEY (PRODUCT_ID)
        REFERENCES vpv4.PRODUCTS (PRODUCT_ID)
        ON DELETE CASCADE,
    CONSTRAINT FK_PRODUCTS_SUBSTANCES_SUBSTANCE FOREIGN KEY (ACTIVE_SUBSTANCE_ID)
        REFERENCES vpv4.ACTIVE_SUBSTANCES (ACTIVE_SUBSTANCE_ID)
        ON DELETE CASCADE
);

-- Adverse Drug Reactions table
CREATE TABLE IF NOT EXISTS vpv4.ADVERSE_DRUG_REACTIONS (
    ADVERSE_DRUG_REACTION_ID INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    ADVERSE_DRUG_REACTION_NAME TEXT NOT NULL,
    CREATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT PK_ADR PRIMARY KEY (ADVERSE_DRUG_REACTION_ID)
);

-- Synonyms table for adverse drug reactions
CREATE TABLE IF NOT EXISTS vpv4.SYNONYMS (
    SYNONYM_ID INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    ADVERSE_DRUG_REACTION_ID INTEGER NOT NULL,
    SYNONYM_NAME TEXT NOT NULL,
    CREATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT PK_SYNONYMS PRIMARY KEY (SYNONYM_ID),
    CONSTRAINT FK_SYNONYMS_ADR FOREIGN KEY (ADVERSE_DRUG_REACTION_ID)
        REFERENCES vpv4.ADVERSE_DRUG_REACTIONS (ADVERSE_DRUG_REACTION_ID)
        ON UPDATE NO ACTION
        ON DELETE NO ACTION
);

-- Medical specialties table
CREATE TABLE IF NOT EXISTS vpv4.SPECIALTIES (
    SPECIALTY_ID INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    AREA TEXT NOT NULL,
    CREATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT PK_SPECIALTIES PRIMARY KEY (SPECIALTY_ID)
);

-- Para-clinical areas table
CREATE TABLE IF NOT EXISTS vpv4.PARA_CLINICS (
    PARA_CLINIC_ID INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    PARA_CLINIC_NAME TEXT NOT NULL,
    CREATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT PK_PARA_CLINICS PRIMARY KEY (PARA_CLINIC_ID)
);

-- Organs table (hierarchical structure)
CREATE TABLE IF NOT EXISTS vpv4.ORGANS (
    ORGAN_ID INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    PARENT_ORGAN_ID INTEGER,
    ORGAN_NAME TEXT NOT NULL,
    ORGAN_TYPE TEXT,
    CREATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT PK_ORGANS PRIMARY KEY (ORGAN_ID),
    CONSTRAINT FK_ORGANS_PARENT_ORGAN_ID FOREIGN KEY (PARENT_ORGAN_ID)
        REFERENCES vpv4.ORGANS (ORGAN_ID)
        ON UPDATE NO ACTION
        ON DELETE NO ACTION
);

-- Frequency groups for adverse drug reactions
CREATE TABLE IF NOT EXISTS vpv4.FREQUENCIES (
	FREQUENCY_ID INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
	FREQUENCY_GROUP TEXT NOT NULL,
	CREATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
	UPDATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
	CONSTRAINT PK_FREQUENCIES PRIMARY KEY (FREQUENCY_ID),
	CONSTRAINT FREQUENCIES_FREQUENCY_GROUP_CHECK CHECK (FREQUENCY_GROUP IN ('Meget almindelige (> 10 %)', 'Almindelige (1-10 %)', 'Ikke almindelige (0,1-1 %)', 'Sjældne (0,01-0,1 %)', 'Meget sjældne (< 0,01 %)', 'Ikke kendt hyppighed'))
);

-- Junction table: Products, Adverse Drug Reactions, and Frequencies
CREATE TABLE IF NOT EXISTS vpv4.PRODUCTS_ADVERSE_DRUG_REACTIONS_FREQUENCIES (
	PRODUCT_ID INTEGER NOT NULL,
    ADVERSE_DRUG_REACTION_ID INTEGER NOT NULL,
    FREQUENCY_ID INTEGER NOT NULL,
    CREATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT PK_PRODUCTS_ADR_FREQUENCIES PRIMARY KEY (PRODUCT_ID, ADVERSE_DRUG_REACTION_ID, FREQUENCY_ID),
    CONSTRAINT FK_PRODUCTS_ADR_FREQUENCIES FOREIGN KEY (PRODUCT_ID)
		REFERENCES vpv4.PRODUCTS (PRODUCT_ID)
		ON UPDATE NO ACTION
		ON DELETE CASCADE,
	CONSTRAINT FK_ADR_FREQUENCIES_PRODUCTS FOREIGN KEY (ADVERSE_DRUG_REACTION_ID)
		REFERENCES vpv4.ADVERSE_DRUG_REACTIONS (ADVERSE_DRUG_REACTION_ID)
		ON UPDATE NO ACTION
		ON DELETE CASCADE,
	CONSTRAINT FK_FREQUENCIES_PRODUCTS_ADR FOREIGN KEY (FREQUENCY_ID)
		REFERENCES vpv4.FREQUENCIES (FREQUENCY_ID)
		ON UPDATE NO ACTION
		ON DELETE CASCADE
);

-- Junction table: Adverse Drug Reactions and Organs
CREATE TABLE IF NOT EXISTS vpv4.ADVERSE_DRUG_REACTIONS_ORGANS (
    ADVERSE_DRUG_REACTION_ID INTEGER NOT NULL,
    ORGAN_ID INTEGER NOT NULL,
    CREATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT PK_ADR_ORGANS PRIMARY KEY (ADVERSE_DRUG_REACTION_ID, ORGAN_ID),
    CONSTRAINT FK_ADR_ORGANS FOREIGN KEY (ADVERSE_DRUG_REACTION_ID)
        REFERENCES vpv4.ADVERSE_DRUG_REACTIONS (ADVERSE_DRUG_REACTION_ID)
        ON UPDATE NO ACTION
        ON DELETE CASCADE,
    CONSTRAINT FK_ORGANS_ADR FOREIGN KEY (ORGAN_ID)
        REFERENCES vpv4.ORGANS (ORGAN_ID)
        ON UPDATE NO ACTION
        ON DELETE CASCADE
);

-- Junction table: Adverse Drug Reactions and Para-Clinics
CREATE TABLE IF NOT EXISTS vpv4.ADVERSE_DRUG_REACTIONS_PARA_CLINICS (
    ADVERSE_DRUG_REACTION_ID INTEGER NOT NULL,
    PARA_CLINIC_ID INTEGER NOT NULL,
    CREATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT PK_ADR_PARA_CLINICS PRIMARY KEY (ADVERSE_DRUG_REACTION_ID, PARA_CLINIC_ID),
    CONSTRAINT FK_ADR_PARA_CLINICS FOREIGN KEY (ADVERSE_DRUG_REACTION_ID)
        REFERENCES vpv4.ADVERSE_DRUG_REACTIONS (ADVERSE_DRUG_REACTION_ID)
        ON UPDATE NO ACTION
        ON DELETE CASCADE,
    CONSTRAINT FK_PARA_CLINICS_ADR FOREIGN KEY (PARA_CLINIC_ID)
        REFERENCES vpv4.PARA_CLINICS (PARA_CLINIC_ID)
        ON UPDATE NO ACTION
        ON DELETE CASCADE
);

-- Junction table: Adverse Drug Reactions and Specialties
CREATE TABLE IF NOT EXISTS vpv4.ADVERSE_DRUG_REACTIONS_SPECIALTIES (
    ADVERSE_DRUG_REACTION_ID INTEGER NOT NULL,
    SPECIALTY_ID INTEGER NOT NULL,
    CREATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT PK_ADR_SPECIALTIES PRIMARY KEY (ADVERSE_DRUG_REACTION_ID, SPECIALTY_ID),
    CONSTRAINT FK_ADR_SPECIALTIES FOREIGN KEY (ADVERSE_DRUG_REACTION_ID)
        REFERENCES vpv4.ADVERSE_DRUG_REACTIONS (ADVERSE_DRUG_REACTION_ID)
        ON UPDATE NO ACTION
        ON DELETE CASCADE,
    CONSTRAINT FK_SPECIALTIES_ADR FOREIGN KEY (SPECIALTY_ID)
        REFERENCES vpv4.SPECIALTIES (SPECIALTY_ID)
        ON UPDATE NO ACTION
        ON DELETE CASCADE
);

-- Junction table: Manufacturers and Products
CREATE TABLE IF NOT EXISTS vpv4.MANUFACTURERS_PRODUCTS (
    MANUFACTURER_ID INTEGER NOT NULL,
    PRODUCT_ID INTEGER NOT NULL,
    CREATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT PK_MANUFACTURERS_PRODUCTS PRIMARY KEY (MANUFACTURER_ID, PRODUCT_ID),
    CONSTRAINT FK_MANUFACTURERS_PRODUCTS FOREIGN KEY (MANUFACTURER_ID)
        REFERENCES vpv4.MANUFACTURERS (MANUFACTURER_ID)
        ON UPDATE NO ACTION
        ON DELETE CASCADE,
    CONSTRAINT FK_PRODUCTS_MANUFACTURERS FOREIGN KEY (PRODUCT_ID)
        REFERENCES vpv4.PRODUCTS (PRODUCT_ID)
        ON UPDATE NO ACTION
        ON DELETE CASCADE
);

-- Deprescribing Conditions table
CREATE TABLE IF NOT EXISTS vpv4.DEPRESCRIBING_CONDITIONS (
    CONDITION_ID INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY (INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1),
    CONDITION_TYPE VARCHAR(50) NOT NULL,
    CONDITION_DESCRIPTION TEXT NOT NULL,
    CONSTRAINT PK_DEPRESCRIBING_CONDITIONS PRIMARY KEY (CONDITION_ID)
);

-- Deprescribing Guidelines table
CREATE TABLE IF NOT EXISTS vpv4.DEPRESCRIBING_GUIDELINES (
    GUIDELINE_ID INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY (INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1),
    ACTIVE_SUBSTANCE_ID INTEGER NOT NULL,
    WHEN_TO_DEPRESCRIBE TEXT NOT NULL,
    HOW_TO_DEPRESCRIBE TEXT NOT NULL,
    TRAFFIC_WARNING BOOLEAN DEFAULT false,
    ANTICHOLINERGIC_EFFECT BOOLEAN DEFAULT false,
    GUIDELINE_VERSION DATE NOT NULL,
    IS_CURRENT BOOLEAN DEFAULT true,
    CREATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT PK_DEPRESCRIBING_GUIDELINES PRIMARY KEY (GUIDELINE_ID),
    CONSTRAINT FK_DEPRESCRIBING_ACTIVE_SUBSTANCE FOREIGN KEY (ACTIVE_SUBSTANCE_ID)
        REFERENCES vpv4.ACTIVE_SUBSTANCES (ACTIVE_SUBSTANCE_ID)
        ON DELETE CASCADE
);

-- Import Staging table for products and substances
CREATE TABLE IF NOT EXISTS vpv4.IMPORT_STAGING_PRODUCTS_SUBSTANCES (
    STAGING_ID INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY (INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1),
    DRUG_ID BIGINT NOT NULL,
    ACTIVE_SUBSTANCE_NAME TEXT NOT NULL,
    PRODUCT_NAME TEXT,
    IS_PRIMARY_SUBSTANCE BOOLEAN DEFAULT true,
    ATC_CODE VARCHAR(7),
    FORM TEXT,
    STRENGTH TEXT,
    IMPORT_STATUS VARCHAR(50) DEFAULT 'PENDING',
    IMPORT_MESSAGE TEXT,
    IMPORT_TIMESTAMP TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT PK_IMPORT_STAGING PRIMARY KEY (STAGING_ID)
);

-- Create performance indexes
CREATE UNIQUE INDEX PRODUCTS_DRUG_ID_IDX ON vpv4.PRODUCTS (DRUG_ID);
CREATE UNIQUE INDEX ADVERSE_DRUG_REACTIONS_ADVERSE_DRUG_REACTION_NAME_IDX ON vpv4.ADVERSE_DRUG_REACTIONS (ADVERSE_DRUG_REACTION_NAME);
CREATE UNIQUE INDEX SYNONYMS_SYNONYM_NAME_IDX ON vpv4.SYNONYMS (SYNONYM_NAME);
CREATE UNIQUE INDEX SPECIALTIES_AREA_IDX ON vpv4.SPECIALTIES (AREA);
CREATE UNIQUE INDEX PARA_CLINICS_PARA_CLINIC_NAME_IDX ON vpv4.PARA_CLINICS (PARA_CLINIC_NAME);
CREATE UNIQUE INDEX ORGANS_ORGAN_NAME_IDX ON vpv4.ORGANS (ORGAN_NAME);
CREATE UNIQUE INDEX ACTIVE_SUBSTANCES_SUBSTANCE_NAME_IDX ON vpv4.ACTIVE_SUBSTANCES (SUBSTANCE_NAME);
CREATE UNIQUE INDEX SUBSTANCE_SYNONYMS_SYNONYM_NAME_IDX ON vpv4.SUBSTANCE_SYNONYMS (SYNONYM_NAME);

-- Create schema version table
CREATE TABLE IF NOT EXISTS vpv4.schema_version (
    version VARCHAR(20) PRIMARY KEY,
    applied_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    description TEXT
);

-- Insert schema version
INSERT INTO vpv4.schema_version (version, description)
VALUES ('2.0.0', 'Complete VelPharma Drug Database v4 schema with active substances and deprescribing')
ON CONFLICT (version) DO NOTHING;

-- Grant permissions to postgres user
GRANT USAGE ON SCHEMA vpv4 TO postgres;
GRANT CREATE ON SCHEMA vpv4 TO postgres;
GRANT ALL ON ALL TABLES IN SCHEMA vpv4 TO postgres;
GRANT ALL ON ALL SEQUENCES IN SCHEMA vpv4 TO postgres;
GRANT ALL ON ALL FUNCTIONS IN SCHEMA vpv4 TO postgres;

-- Set default privileges for future objects
ALTER DEFAULT PRIVILEGES IN SCHEMA vpv4 GRANT ALL ON TABLES TO postgres;
ALTER DEFAULT PRIVILEGES IN SCHEMA vpv4 GRANT ALL ON SEQUENCES TO postgres;
ALTER DEFAULT PRIVILEGES IN SCHEMA vpv4 GRANT ALL ON FUNCTIONS TO postgres;

-- Add table comments
COMMENT ON TABLE vpv4.PRODUCTS IS 'Main table containing drug product information';
COMMENT ON TABLE vpv4.ATC_CODES IS 'Anatomical Therapeutic Chemical Classification codes (WHO ATC system)';
COMMENT ON TABLE vpv4.MANUFACTURERS IS 'Drug manufacturers information';
COMMENT ON TABLE vpv4.ADVERSE_DRUG_REACTIONS IS 'Adverse drug reaction definitions';
COMMENT ON TABLE vpv4.FREQUENCIES IS 'Frequency groups for adverse drug reactions occurrence';
COMMENT ON TABLE vpv4.ACTIVE_SUBSTANCES IS 'Active pharmaceutical ingredients/substances';
COMMENT ON TABLE vpv4.PRODUCTS_ACTIVE_SUBSTANCES IS 'Junction table linking products to their active substances';
COMMENT ON TABLE vpv4.DEPRESCRIBING_GUIDELINES IS 'Guidelines for medication deprescribing';
COMMENT ON TABLE vpv4.DEPRESCRIBING_CONDITIONS IS 'Conditions that may warrant deprescribing';
COMMENT ON TABLE vpv4.IMPORT_STAGING_PRODUCTS_SUBSTANCES IS 'Staging table for importing product and substance data';